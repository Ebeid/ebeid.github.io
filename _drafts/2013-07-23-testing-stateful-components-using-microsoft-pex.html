---
layout: post
title: Testing stateful components using Microsoft Pex
date: '2013-07-23T17:34:00.000-05:00'
author: Ebeid Soliman ElSayed
tags:
- Microsoft Pex
- Parameterized Unit Tests
- Unit Tests
- Unit testing
modified_time: '2013-07-23T17:34:23.730-05:00'
blogger_id: tag:blogger.com,1999:blog-59384554657271185.post-3687913190221570070
---

&lt;<draft>&gt;  </draft><br />Pattern. This pattern applies for statefull component x that expose members that may transition the state. For each member f(x), one defines a transition type Tf (x; o) which contains a method to invoke f(x) and where o is the test oracle.<br /> Let us illustrate this pattern with the XmlWriter class from the System.Xml library. This class contains a number of methods (Write...) which have to be called in a particular order to build valid XML documents. The writer also exposes a WriteState property which gives a partial view on the state of the writer: <br /><pre class="prettyprint lang-cs">public abstract class XmlWriter<br />{<br /> public abstract void WriteStartElement(string elementName);<br /> public abstract void WriteEndElement();<br /> public abstract WriteState WriteState { get; }<br />}</pre><br />We start by defining an abstract Transition type that will be used to define each possible transition of the XmlWriter:<br /><pre class="prettyprint lang-cs">public abstract class Transition<br />{<br /> public abstract void Execute(XmlWriter writer, XmlWriterOracle oracle);<br />}</pre><br />The second parameter of Execute holds a test oracle that will be used to assert additional properties of the writer:<br /><pre class="prettyprint lang-cs">public sealed class XmlWriterOracle<br />{<br /> public int ElementDepth = 0;<br /> public void Invariant()<br /> {<br />  PexAssert.IsTrue(this.ElementDepth &gt; -1);<br /> }<br />}</pre><br />For each method in XmlWriter, a transition type inherited from Transition can be defined:<br /><pre class="prettyprint lang-cs">[DebuggerDisplay("WriteEndElement")]<br />public class WriteEndElementTransition : Transition<br />{<br /> public override void Execute(XmlWriter writer, XmlWriterOracle oracle)<br /> {<br />  writer.WriteEndElement();<br />  oracle.ElementDepth--;<br /> }<br />}</pre><br />Transitions may also embed assertions and assumptions:<br /><pre class="prettyprint lang-cs">[DebuggerDisplay("WriteStartElement({Name})")]<br />public class WriteStartElementTransition : Transition<br />{<br /> public string Name;<br /> public override void Execute(XmlWriter writer, XmlWriterOracle oracle)<br /> {<br />  writer.WriteStartElement(this.Name);<br />  PexAssert.IsNotNull(this.Name);<br />  PexAssert.AreEqual(writer.WriteState, WriteState.Element);<br />  oracle.ElementDepth++;<br /> }<br />}</pre><br />Finally, the parameterized unit test simply takes a sequence of transitions and executes them:<br /><pre class="prettyprint lang-cs">[PexMethod]<br />[PexUseType(typeof(WriteStartElementTransition))]<br />[PexUseType(typeof(WriteEndElementTransition))]<br />public void WriteXml([PexAssumeNotNull]Transition[] transitions)<br />{<br /> PexAssume.AreElementsNotNull(transitions);<br /> using (var writer = new StringWriter())<br /> using (var xwriter = XmlWriter.Create(writer))<br /> {<br />  var oracle = new XmlWriterOracle();<br />  for (int i = 0; i &lt; transitions.Length; ++i)<br />  {<br />   var transition = transitions[i];<br />   // apply transition<br />   transition.Execute(xwriter, oracle);<br />   // assert invariant still holds<br />   oracle.Invariant();<br />  }<br /> }<br />}</pre><br />The assertions and assumptions embedded in the transitions and product code will drive Pex to instantiate different sequence of transitions. The <strong>PexUseTypeAttribute</strong> annotation on the test specify to Pex that those types should be used when a Transition type is needed. <br />  